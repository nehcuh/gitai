# GitAI 架构概览

GitAI 是一组AI驱动的Git辅助工具，设计理念是**即时性**和**非强制性** - 在开发过程中的任何时刻提供智能帮助，不改变用户现有的Git工作流。

## 核心设计哲学

### 即时性 (Immediacy)
- 在开发过程的任何时刻都能使用
- 提供即时反馈，而不是滞后检查
- 用户主动选择何时使用工具

### 非强制性 (Non-mandatory)
- 所有功能都是可选的
- 不强制改变现有的Git工作流
- 提供建议，不强制执行

### 兼容性 (Compatibility)
- 完全兼容原生Git命令
- 不破坏用户的使用习惯
- 可以与现有工具链无缝集成

## 即时辅助工具架构

GitAI不是强制性的开发流程，而是一组独立的辅助工具，每个工具都可以在需要时单独使用：

```
开发过程中的任意时刻：
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           用户主动选择使用GitAI工具                              │
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │gitai review │  │ gitai scan  │  │gitai commit │  │gitai --ai   │              │
│  │  代码评审   │  │  安全扫描   │  │  智能提交   │  │  Git解释   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                 │                 │                 │                  │
│         ▼                 ▼                 ▼                 ▼                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │多维度分析   │  │OpenGrep扫描 │  │AI生成信息   │  │AI解释输出   │              │
│  │(结构+安全+  │  │(可选语言)   │  │(可选Issue) │  │(帮助学习)   │              │
│  │ 任务上下文) │  │             │  │             │  │             │              │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                 │                 │                 │                  │
│         ▼                 ▼                 ▼                 ▼                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │AI分析报告   │  │安全问题报告 │  │标准化提交   │  │易懂的解释   │              │
│  │(质量建议)   │  │(修复建议)   │  │(符合规范)   │  │(学习辅助)   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                             │
│  用户看到结果后，可以：                                                       │
│  ✅ 采纳建议修改代码                                                         │
│  ✅ 忽略建议继续开发                                                         │
│  ✅ 调整参数重新分析                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           传统Git操作保持不变                                    │
│                                                                             │
│  用户决定何时提交：                                                          │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                        │
│  │   git add   │────▶│  git commit │────▶│   git push  │                        │
│  │ (暂存变更)   │     │ (提交代码)   │     │ (推送到远程) │                        │
│  └─────────────┘     └─────────────┘     └─────────────┘                        │
│                                                                             │
│  注意：GitAI不会强制或改变这个流程！                                           │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 1. 模块与职责

- src/main.rs
  - 启动、解析 CLI、加载配置、路由到各子命令
- src/args.rs
  - CLI 参数定义（Review/Scan/ScanHistory/Prompts/Commit/Update/Git 代理）
- src/config.rs
  - 配置结构体与加载（~/.config/gitai/config.toml）
- src/git.rs
  - Git 子进程封装（run_git、diff/status/add/commit），禁用 pager 保证非交互稳定
- src/scan.rs
  - OpenGrep 集成：规则目录选择（--lang 优先/自动检测作为后备）、构建命令、运行与 JSON 解析、扫描历史持久化、安装帮助
- src/review.rs
  - 评审主流程：获取 diff → 暂存提示 → 缓存 → 获取 Issue 上下文 → 调用 Analyzer → 保存缓存 → 输出（可阻断严重问题）
- src/analysis.rs
  - Analyzer：多维度数据融合分析的核心
    - analyze_review：结合代码结构、安全扫描、任务上下文生成AI提示词
    - analyze_security：按需调用安全扫描，集成到代码评审流程
    - analyze_deviation：分析代码变更与DevOps任务的一致性
- src/commit.rs
  - 智能提交：收集 diff/Issue → 生成提交信息（或使用用户 -m）→ 可选评审 → git add/commit
- src/devops.rs
  - DevOps 客户端（Coding/GitHub）拉取 Issue 简要信息
- src/update/*
  - 自动更新器：规则包下载/解压/元信息写入、prompts（占位）、版本检查与通知
- src/ai.rs
  - AI 请求（OpenAI 兼容），system+user 双消息，支持 api_key/temperature

## 2. CLI 契约（核心）

- gitai review
  - 关键开关：
    - --security-scan（在评审过程中触发 OpenGrep）
    - --block-on-critical（Error 级别时非零退出）
    - --tree-sitter（当前文档存在，但实现未接入；需恢复）
    - --format/--output
  - 默认不破坏：无扫描、无阻断，纯文本输出至 stdout
- gitai scan
  - 关键开关：--lang、--no-history、--timeout、--format、--auto-install、--update-rules
  - 默认：不写历史（已提供 --no-history 以便基准），JSON 解析整块 results
- gitai commit
  - -m 与 AI 互斥优先：有 -m 则格式化+拼接 Issue 前缀；无 -m 才调用 AI 生成
  - --review 可在提交前做一次评审摘要（不阻断）
- gitai <git 子命令>
  - 默认直通原生输出；--ai 时追加“🤖 AI解释”；失败保持非零退出
- gitai update / prompts
  - update：规则/提示词/版本检查；prompts 的 update 为占位

## 3. 数据与状态

- 配置：~/.config/gitai/config.toml
- 规则：~/.cache/gitai/rules（附 .rules.meta）、语言子目录（java/python/...）
- 扫描历史：~/.cache/gitai/scan_history/scan_<tool>_<ts>.json（可用 --no-history 禁用）
- 评审缓存：~/.cache/gitai/review_cache/review_<cache_key>.json
- Prompts：~/.config/gitai/prompts/*.md（init 时生成默认模板）

## 4. 多维度数据融合设计

GitAI的核心价值在于将多个维度的数据融合分析，提供比单一工具更全面的理解：

### 数据融合架构

```
代码变更 (diff)
    ↓
┌─────────────────────────────────────────────────────────────────┐
│                    多维度数据采集                              │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────┐ │
│  │Tree-sitter  │  │ 安全扫描     │  │ DevOps任务  │  │ 缓存   │ │
│  │  结构分析   │  │ OpenGrep    │  │ 上下文     │  │ 系统   │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────┘ │
│         │                 │                 │          │       │
│         ▼                 ▼                 ▼          ▼       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────┐ │
│  │代码结构信息  │  │安全问题列表  │  │任务描述     │  │缓存命中│ │
│  │函数/类等    │  │严重程度/位置 │  │需求/优先级  │  │性能优化│ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    AI提示词构建                                 │
│                                                                 │
│  结合所有维度信息，构建上下文丰富的提示词：                       │
│  - 代码变更内容                                                   │
│  - 结构分析结果                                                   │
│  - 安全问题报告                                                   │
│  - 任务上下文信息                                                   │
│  - 偏离度分析要求                                                   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    AI综合分析                                   │
│                                                                 │
│  AI基于多维度信息提供：                                         │
│  - 代码质量评估                                                   │
│  - 安全风险分析                                                   │
│  - 任务完成度评估                                                 │
│  - 具体改进建议                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 关键流程

- Review 流（多维度融合）：
  1) diff = git.get_all_diff()
  2) 暂存状态提示（非强制）
  3) cache_key = md5(diff + language + security_scan + deviation + issue_ids)
  4) 若命中缓存 → 输出 → 结束
  5) 并行采集多维度数据：
     - structural_summary = TreeSitter.analyze(diff) （可选）
     - issues = DevOps.get_issues(issue_ids) （可选）
  6) analysis = Analyzer.analyze(context)
     - 构建包含所有维度的AI提示词
     - review_result = AI 综合分析结果
     - security_findings = 安全扫描结果（按需）
     - deviation_analysis = 任务偏离度分析（按需）
  7) 保存缓存 + 输出 + （可选阻断）

- Scan 流：
  1) 选择规则目录：--lang 优先；否则自动统计主语言 → 子目录；不存在则回退根目录
  2) 构建 opengrep 参数（--json/--quiet/--timeout）+ 可选 --jobs
  3) 执行并解析 results 数组 → 写历史（可禁用）→ 输出（text 或 json）

- Commit 流：
  1) diff/issue 上下文 → AI 生成或使用 -m
  2) 可选评审摘要（不阻断）
  3) git add/commit

- Git 代理：
  1) 运行原生命令捕获 stdout/stderr+退出码 → 直通 → 可选 AI 解释 → 保持退出码

## 5. 行为契约（Never break userspace）

- 不替换 git，也不默认改写输出或退出码
- 所有增强（AI解释、阻断、扫描）均显式开关
- 错误时保留原始 stderr，并保持非零退出码

## 6. 性能与可用性

- 封装层对 opengrep 的开销：< 1s（当前基准约 1.28x 原生）；提供 --lang/--no-history/--timeout/--benchmark 以对齐条件
- 复杂命令的分页/交互风险：禁用 pager 保证非交互输出

## 7. 风险与已知差异

- Tree‑sitter：CLI 有开关，但未接入 Analyzer；文档存在超前描述
- Prompts.update：占位未实现真实源
- README 与实现细节：已做一轮对齐，但仍需二次审视（尤其 Tree‑sitter 章节）

## 8. 设计原则

### 即时性原则
- 工具应该在用户需要时立即可用
- 不强制等待特定的开发阶段
- 提供即时反馈，而非滞后检查

### 非强制性原则
- 所有功能都是可选的，用户主动选择
- 不改变现有的Git工作流
- 提供建议，不强制执行

### 兼容性原则
- 完全兼容原生Git命令
- 不破坏用户的使用习惯
- 可以与现有工具链无缝集成

### 性能优化原则
- 智能缓存避免重复计算
- 并行采集多维度数据
- 提供性能基准测试模式

### 渐进式采用原则
- 用户可以从单个功能开始尝试
- 逐步探索和使用更多功能
- 每个功能都有独立的价值

## 9. 后续演进（简述）

- 恢复并接入 Tree‑sitter（最小可用：结构摘要注入 prompt）
- 完成 prompts.update 真实源同步（git/URL），含重试与校验
- 加 smoke tests 与基准章节的自动化脚本

