# GitAI 项目重构计划

## 重构目标
1. 提升代码组织结构的清晰度和模块化
2. 移除 tree-sitter 依赖，专注于 ast-grep 集成
3. 统一翻译模块，使用AI提示词实现全局翻译功能
4. 改善错误处理和配置管理系统
5. 提供更好的开发文档和测试覆盖率

## 当前架构问题分析

### 1. 模块结构问题
- `main.rs` 过于复杂，包含了太多业务逻辑
- `handlers/` 目录混合了不同层次的功能
- 缺乏清晰的领域边界

### 2. 依赖问题
- 残留的 tree-sitter 引用需要清理
- 配置文件中的 tree-sitter 配置需要更新为 ast-grep

### 3. 翻译模块问题
- 翻译功能分散在ast-grep模块中，应该提升为全局功能
- 当前翻译实现与项目整体AI架构不一致
- 已有translator.md提示词未充分利用
- 缺乏与AI配置的统一管理

### 4. 错误处理问题
- 错误类型分散且不一致
- 缺乏统一的错误处理策略

## 新的模块架构设计

```
src/
├── main.rs                    # 简化的CLI入口点
├── lib.rs                     # 库导出
├── app.rs                     # 应用程序主逻辑
├── cli/                       # CLI相关功能
│   ├── mod.rs
│   ├── parser.rs             # 参数解析
│   ├── commands.rs           # 命令定义
│   └── help.rs               # 帮助系统
├── git/                       # Git核心操作（项目的基础）
│   ├── mod.rs
│   ├── operations.rs         # Git基础操作
│   ├── diff.rs               # 差异分析
│   ├── commit.rs             # 提交相关
│   └── repository.rs         # 仓库管理
├── ai/                        # AI能力模块（为其他功能提供AI支持）
│   ├── mod.rs
│   ├── client.rs             # AI客户端
│   ├── prompts.rs            # 提示词管理
│   ├── chat.rs               # 对话接口
│   └── analysis.rs           # AI分析能力
├── review/                    # 代码审查功能（Git + AI + AST-Grep）
│   ├── mod.rs
│   ├── engine.rs             # 审查引擎
│   ├── report.rs             # 报告生成
│   └── storage.rs            # 审查结果存储
├── analysis/                  # 代码分析模块（Git + AST-Grep）
│   ├── mod.rs
│   └── ast_grep/             # AST-Grep分析
│       ├── mod.rs
│       ├── analyzer.rs       # 分析器
│       ├── rules.rs          # 规则管理
│       └── cache.rs          # 缓存管理
├── translation/              # 全局翻译功能（AI驱动）
│   ├── mod.rs
│   ├── translator.rs         # AI驱动的翻译器
│   ├── prompts.rs            # 翻译提示词管理
│   └── cache.rs              # 翻译缓存
├── devops/                   # DevOps集成（扩展Git工作流）
│   ├── mod.rs
│   ├── client.rs             # DevOps客户端
│   ├── integration.rs        # 工作流集成
│   └── types.rs              # DevOps类型
├── config/                   # 配置管理
│   ├── mod.rs
│   ├── app.rs                # 应用配置
│   └── loader.rs             # 配置加载器
├── common/                   # 通用功能
│   ├── mod.rs
│   ├── error.rs              # 错误处理
│   ├── types.rs              # 通用类型
│   └── utils.rs              # 工具函数
└── tests/                    # 集成测试
    ├── mod.rs
    └── fixtures/             # 测试fixtures
```

### 模块依赖关系与职责

#### 核心原则
- **Git模块**: 项目的基础核心，所有功能都基于Git操作
- **AI模块**: 横向能力模块，为其他功能模块提供AI支持
- **功能模块**: 基于Git+AI实现具体业务功能

#### 模块依赖图
```
                    ┌─────────────┐
                    │     CLI     │
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │     App     │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐        ┌────▼────┐        ┌───▼────┐
   │   Git   │◄───────┤   AI    │────────►│ Trans  │
   │ (核心)   │        │ (能力)   │        │ (全局)  │
   └────┬────┘        └────┬────┘        └────────┘
        │                  │
   ┌────▼────┐        ┌────▼────┐
   │ Review  │        │Analysis │
   │(Git+AI) │        │(Git+AST)│
   └─────────┘        └─────────┘
        │
   ┌────▼────┐
   │ DevOps  │
   │(Git扩展) │
   └─────────┘
```

#### 各模块职责
- **Git**: 提供所有Git基础操作（diff、commit、status等）
- **AI**: 提供统一的AI能力接口（chat、分析、增强等）
- **Translation**: 全局翻译服务（使用AI实现）
- **Review**: 智能代码审查（Git + AI + AST-Grep）
- **Analysis**: 代码分析功能（Git + AST-Grep）
- **DevOps**: DevOps平台集成（扩展Git工作流）

## 重构实施计划

### Phase 1: 基础重构
1. ✅ 移除tree-sitter引用
2. 🔄 重新组织模块结构
3. 📋 重构错误处理系统
4. 📋 改善配置管理

### Phase 2: 核心功能优化
1. 📋 优化AI集成模块
2. 📋 增强AST-Grep分析功能
3. 📋 重构翻译系统为全局AI驱动模块
4. 📋 统一翻译配置与AI配置管理
5. 📋 优化DevOps集成

### Phase 3: 文档和测试
1. 📋 完善API文档
2. 📋 增加集成测试
3. 📋 创建开发指南
4. 📋 性能优化

## 实施细节

### 1. 模块重构优先级
- **高优先级**: CLI解析、错误处理、配置管理、全局翻译系统
- **中优先级**: AI集成、AST-Grep分析、Git操作
- **低优先级**: DevOps集成、测试优化

### 2. 向后兼容性
- 保持CLI接口不变
- 保持配置文件格式兼容
- 保持主要功能的行为一致

### 3. 质量保证
- 每个模块都有对应的测试
- 使用clippy进行代码质量检查
- 定期运行性能基准测试

## 成功标准
1. 代码模块化程度显著提升
2. 错误处理更加统一和友好
3. 配置管理更加灵活
4. 文档完整且易于理解
5. 测试覆盖率达到80%以上
6. 性能不低于当前版本

## 风险评估
- **技术风险**: 重构过程中可能引入新的bug
- **时间风险**: 重构工作量较大，需要合理安排时间
- **兼容性风险**: 确保重构后功能保持一致

## 下一步行动
1. 开始实施模块重构
2. 逐步迁移现有代码到新架构
3. 编写测试确保功能正确性
4. 更新文档和使用指南