# 用户故事: 自定义提交信息支持

## 故事描述

**作为一个**开发者  
**我希望**使用 `gitai commit -m "my message"` 命令提供自定义提交信息  
**以便于**在保留我的原始想法的同时，获得 AI 生成的补充信息和建议

## 验收标准

### AC1: 标准 -m 参数支持
- **给定**我想要提供自定义的提交信息
- **当**我执行 `gitai commit -m "my custom message"` 命令时
- **那么**系统应该保留我的原始提交信息
- **并且**生成 AI 建议作为补充内容

### AC2: 混合模式提交信息
- **给定**用户提供了自定义提交信息
- **当**系统生成最终的提交信息时
- **那么**应该按照以下结构组织：
  - 用户原始提交信息作为主要内容
  - AI 生成的分析和建议作为独立章节
  - 清晰的分隔和标识

### AC3: 多行提交信息支持
- **给定**用户需要提供详细的提交说明
- **当**用户使用 `-m` 参数或交互式编辑器时
- **那么**系统应该支持多行提交信息
- **并且**正确处理格式和换行

### AC4: 交互式编辑模式
- **给定**用户没有通过 `-m` 提供提交信息
- **当**系统生成 AI 提交信息后
- **那么**应该打开默认编辑器让用户编辑
- **并且**在编辑器中展示 AI 生成的内容供参考

### AC5: 与其他功能的集成
- **给定**用户同时使用 `-m` 和 `-t` 参数
- **当**系统处理提交时
- **那么**应该结合 Tree-sitter 分析和审查结果
- **并且**在 AI 补充章节中体现这些增强分析

## 技术要求

### 参数解析增强
- 支持标准的 `-m` 和 `--message` 参数
- 处理带引号和不带引号的消息内容
- 支持多个 `-m` 参数的组合
- 与现有参数的兼容性处理

### 提交信息结构
- 用户消息的原样保留
- AI 内容的结构化呈现
- 适当的分隔符和格式化
- 符合 Git 提交信息规范

### 编辑器集成
- 调用系统默认的 Git 编辑器
- 预填充 AI 生成的内容
- 处理编辑器退出状态
- 支持不同操作系统的编辑器

## 实现细节

### 命令解析逻辑
```rust
// 检测自定义消息参数
let custom_message = extract_message_from_args(&args);
let has_custom_message = custom_message.is_some();

// 根据是否有自定义消息决定处理流程
if has_custom_message {
    // 混合模式处理
    generate_enhanced_commit_with_custom_message(custom_message.unwrap(), context).await
} else {
    // 标准 AI 生成模式
    generate_ai_commit_message(context).await
}
```

### 混合模式提交信息格式
```
{用户自定义提交信息}

---
## AI Analysis & Suggestions

### Code Changes Summary
- Modified authentication logic in src/auth.rs
- Added input validation for user registration
- Updated error handling in login flow

### Potential Improvements
- Consider adding rate limiting for login attempts
- Suggest implementing password strength validation
- Recommend adding audit logging for security events

### Technical Notes
- Function complexity increased in validate_user()
- New dependency added: regex crate
- Test coverage: 85% → 92%

Generated by GitAI | Review ID: abc123
```

### 交互式编辑器模式
```
# Please enter the commit message for your changes. Lines starting
# with '#' will be ignored, and an empty message aborts the commit.
#
# AI Generated Suggestion:
# feat(auth): implement enhanced user authentication
# 
# - Add comprehensive input validation
# - Implement secure password hashing
# - Add rate limiting protection
#
# Changes detected:
#   modified:   src/auth.rs
#   new file:   src/validators.rs
#   modified:   tests/auth_tests.rs
#
# AI Analysis:
# - Security improvements detected
# - Test coverage increased
# - No breaking changes found
```

### 参数处理逻辑
```rust
fn extract_message_from_args(args: &[String]) -> Option<String> {
    let mut message_parts = Vec::new();
    let mut i = 0;
    
    while i < args.len() {
        if args[i] == "-m" || args[i] == "--message" {
            if i + 1 < args.len() {
                message_parts.push(args[i + 1].clone());
                i += 2;
            } else {
                return None; // Error: -m without message
            }
        } else {
            i += 1;
        }
    }
    
    if message_parts.is_empty() {
        None
    } else {
        Some(message_parts.join("\n\n"))
    }
}
```

### 配置选项
```toml
[commit_message]
enable_ai_enhancement = true
show_analysis_section = true
show_suggestions_section = true
editor_template_enabled = true
max_custom_message_length = 2048

[editor]
use_git_editor = true
fallback_editor = "vim"
template_comments = true
show_ai_suggestions_in_template = true
```

## 错误处理

### 常见错误场景
- `-m` 参数后缺少消息内容
- 提交信息过长或包含无效字符
- 编辑器调用失败
- 用户在编辑器中取消提交

### 错误处理策略
- 提供清晰的参数使用说明
- 验证提交信息的有效性
- 优雅处理编辑器相关错误
- 支持强制提交模式

## 用户体验设计

### 输出格式示例
```
🔧 Custom commit message detected
📝 Generating AI enhancements...

Your commit message:
┌─────────────────────────────────────────────┐
│ fix: resolve authentication timeout issue   │
│                                             │
│ - Updated session management logic          │
│ - Fixed race condition in auth middleware   │
└─────────────────────────────────────────────┘

🤖 AI Enhanced Analysis:
✅ Security improvements detected
📊 Performance impact: Minimal
🧪 Test coverage: Maintained at 89%
⚠️  Suggestion: Consider adding integration tests

Continue with this commit? [Y/n] 
```

### 交互流程
1. 解析用户自定义消息
2. 执行代码分析（Tree-sitter, review 等）
3. 生成 AI 补充内容
4. 展示完整的提交信息预览
5. 用户确认或进入编辑模式
6. 执行最终提交

## 完成定义

- [ ] 实现 `-m` 和 `--message` 参数解析
- [ ] 开发混合模式提交信息生成逻辑
- [ ] 集成系统编辑器调用功能
- [ ] 实现交互式确认和编辑流程
- [ ] 添加提交信息验证和错误处理
- [ ] 设计用户友好的输出格式
- [ ] 与 Tree-sitter 和审查集成功能联调
- [ ] 编写自定义消息处理的单元测试
- [ ] 创建不同使用场景的集成测试
- [ ] 添加编辑器兼容性测试
- [ ] 更新用户文档和使用示例

## 相关依赖

- 基础提交功能 (故事 01)
- Tree-sitter 增强分析 (故事 02) 
- 审查集成功能 (故事 03)
- 系统编辑器接口
- Git 命令行兼容性
- 配置系统

## 优先级

**中高** - 重要的用户体验功能，提高工具的灵活性和采用率

## 估算

**开发工作量**: 3-4 个开发日  
**测试工作量**: 2-3 个开发日

## 风险和缓解

### 主要风险
- 编辑器兼容性问题
- 提交信息格式的复杂性
- 与标准 Git 工作流的冲突
- 不同操作系统的行为差异

### 缓解策略
- 广泛测试主流编辑器的集成
- 提供清晰的格式化规则和示例
- 严格遵循 Git 提交信息标准
- 实现跨平台的统一行为